## KeysForStudent
### Telegram-bot для Prog.kiev.ua, который выдает лицензии на продукты IntelliJ

#### Подготовка перед деплоем
1. **Нам нужен хостинг с SSL-сертификатом.** Это важный пункт, без него невозможен следующий.
    Для тестов, я выбирал Heroku за 7$ в месяц. Дешевле DigitalOcean - 5$, но требуеться ручная настройка.
2. **На этом пункте желательно позаботиться о БД.** Я выбрал Free Postgres от Heroku
3. **Аккаунт в AmoCRM**
   - регистрируемся;
   - переходим в "Настроки" -> "Интеграции" -> "+ Создать интеграцию";
   - указываем ссылку на приложение "https://..." - вот здесь нам и нужен SSL;
   - указываем остальные данные и создаем интеграцию;
   - сохраняем *id и secret*.
4. **Console Google**
   - в консоли создаем новый проект;
   - переходим в "Меню" -> "API и сервисы" -> "Учетные данные";
   - нажимаем "+ Создать учетные данные" -> "Идентификатор клиента OAuth";
   - выбираем "Веб-приложение", даем ему название;
   - "Разрешенные источники JavaScript" - ссылка на наше приложение и "http://localhost:port";
   - "Разрешенные URI перенаправления" - http://localhost:port/Callback - необходимо для получения разрешений;
   - после создания скачиваем json-файл и даем ему имя *"client_secret.json"*;
   - ложим *"client_secret.json"* в корневой каталог проекта.
5. **Заходим в Google Drive**, где у нас лежат ключи к Идее и создаем еще один каталог, для использованных ключей.
6. **Регистрируем бота в Telegram у @BotFather**
   - */start*
   - */newbot* -> *NameBot* -> *UserNameBot* - бот создан, сохраните логин и API токен;
   - */setuserpic* - установите аватарку размером 150*150. Это сразу +20 к крутости вашего бота.
8. **В *"application.properties"* заполняем данные для подключения к БД.**
9. **В *"telegram.properties"* указываем:**
   - *UserNameBot* и токен;
   - ссылку на вашу AmoCRM "https://mycrm.amocrm.ru/";
   - тут же данные по интеграции AmoCRM: *id, secret* и ссылку на ваше приложение "https://myapp.com";
   - указываем имена каталогов из Google Drive для новых и использованных ключей Идеи.
   
#### Запускаем приложение локально!
Это необходимо для получения файла с разрешениями от Google. Стандарнтый метод для получения разрешения имеет константу 'localhost', поэтому такие костыли. 
Но это позводит нам выдать разрешения раз и навсегда.
1. **Напишите своему боту.** Бот предложит авторизоваться. Первый авторизовавшийся - администратор.
2. **В консоль приложения прийдет ссылка, которую необходимо открыть в браузере.** Там выбираем аккаунт и соглашаемся с предоставляемыми разрешениями.
3. **Подключение аккаунта AmoCRM.** Бот предложит авторизоваться. Аккаунт не важен - нам нужны разрешения только на чтение - это есть у всех.

После всех этих действий, в директории проекта появиться папка *tokens*, а в ней файл с байтовым содержимым - это разрешения от Google выданные вашему приложению.
**Далее деплоим приложение и все.**
